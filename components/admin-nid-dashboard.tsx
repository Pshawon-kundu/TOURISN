import React, { useState, useEffect } from 'react';\nimport {\n  View,\n  Text,\n  StyleSheet,\n  ScrollView,\n  TouchableOpacity,\n  Alert,\n  RefreshControl,\n} from 'react-native';\nimport { Ionicons } from '@expo/vector-icons';\nimport { APIClient } from '@/lib/api';\nimport { useThemeColors } from '@/hooks/use-theme-colors';\n\ninterface VerificationRecord {\n  id: string;\n  user_id: string;\n  nid_number: string;\n  status: string;\n  verification_score: number;\n  created_at: string;\n  user_email?: string;\n  user_name?: string;\n  security_flags?: string[];\n  ocr_confidence?: number;\n}\n\ninterface SecurityStats {\n  totalVerifications: number;\n  pendingReview: number;\n  verified: number;\n  rejected: number;\n  flagged: number;\n  averageScore: number;\n}\n\nexport default function AdminNIDDashboard() {\n  const colors = useThemeColors();\n  const [verifications, setVerifications] = useState<VerificationRecord[]>([]);\n  const [stats, setStats] = useState<SecurityStats>({\n    totalVerifications: 0,\n    pendingReview: 0,\n    verified: 0,\n    rejected: 0,\n    flagged: 0,\n    averageScore: 0\n  });\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n  const [filter, setFilter] = useState<string>('all');\n\n  useEffect(() => {\n    loadVerifications();\n  }, [filter]);\n\n  const loadVerifications = async () => {\n    try {\n      const response = await APIClient.get('/admin/nid-verifications', {\n        params: { status: filter !== 'all' ? filter : undefined }\n      });\n      \n      if (response.data.success) {\n        setVerifications(response.data.data.verifications);\n        setStats(response.data.data.stats);\n      }\n    } catch (error) {\n      console.error('Failed to load verifications:', error);\n      Alert.alert('Error', 'Failed to load verification data');\n    } finally {\n      setLoading(false);\n      setRefreshing(false);\n    }\n  };\n\n  const handleRefresh = () => {\n    setRefreshing(true);\n    loadVerifications();\n  };\n\n  const updateVerificationStatus = async (verificationId: string, newStatus: string) => {\n    try {\n      const response = await APIClient.patch(`/nid/admin/${verificationId}`, {\n        status: newStatus,\n        notes: `Status updated by admin at ${new Date().toISOString()}`\n      });\n      \n      if (response.data.success) {\n        Alert.alert('Success', `Verification ${newStatus} successfully`);\n        loadVerifications(); // Refresh the list\n      }\n    } catch (error: any) {\n      Alert.alert('Error', error.response?.data?.message || 'Failed to update status');\n    }\n  };\n\n  const getStatusColor = (status: string): string => {\n    switch (status) {\n      case 'verified': return '#10B981';\n      case 'rejected': return '#EF4444';\n      case 'pending_review': return '#F59E0B';\n      case 'flagged_for_review': return '#EF4444';\n      default: return colors.textSecondary;\n    }\n  };\n\n  const getStatusIcon = (status: string): string => {\n    switch (status) {\n      case 'verified': return 'checkmark-circle';\n      case 'rejected': return 'close-circle';\n      case 'pending_review': return 'time';\n      case 'flagged_for_review': return 'warning';\n      default: return 'help-circle';\n    }\n  };\n\n  const getRiskLevel = (score: number, securityFlags?: string[]): { level: string; color: string } => {\n    if (securityFlags && securityFlags.includes('high_risk')) {\n      return { level: 'ðŸ”´ High Risk', color: '#EF4444' };\n    }\n    if (score >= 85) return { level: 'ðŸŸ¢ Low Risk', color: '#10B981' };\n    if (score >= 70) return { level: 'ðŸŸ¡ Medium Risk', color: '#F59E0B' };\n    return { level: 'ðŸ”´ High Risk', color: '#EF4444' };\n  };\n\n  const StatCard = ({ title, value, subtitle, color }: any) => (\n    <View style={[styles.statCard, { backgroundColor: colors.surface }]}>\n      <Text style={[styles.statValue, { color: color || colors.primary }]}>\n        {value}\n      </Text>\n      <Text style={[styles.statTitle, { color: colors.textPrimary }]}>\n        {title}\n      </Text>\n      {subtitle && (\n        <Text style={[styles.statSubtitle, { color: colors.textSecondary }]}>\n          {subtitle}\n        </Text>\n      )}\n    </View>\n  );\n\n  const FilterButton = ({ status, label, count }: any) => {\n    const isActive = filter === status;\n    return (\n      <TouchableOpacity\n        style={[\n          styles.filterButton,\n          {\n            backgroundColor: isActive ? colors.primary : colors.surface,\n            borderColor: colors.border\n          }\n        ]}\n        onPress={() => setFilter(status)}\n      >\n        <Text\n          style={[\n            styles.filterButtonText,\n            { color: isActive ? '#FFFFFF' : colors.textPrimary }\n          ]}\n        >\n          {label} ({count})\n        </Text>\n      </TouchableOpacity>\n    );\n  };\n\n  const VerificationItem = ({ item }: { item: VerificationRecord }) => {\n    const risk = getRiskLevel(item.verification_score, item.security_flags);\n    \n    return (\n      <View style={[styles.verificationItem, { backgroundColor: colors.surface, borderColor: colors.border }]}>\n        <View style={styles.itemHeader}>\n          <View style={styles.itemHeaderLeft}>\n            <Ionicons \n              name={getStatusIcon(item.status)} \n              size={24} \n              color={getStatusColor(item.status)} \n            />\n            <View style={styles.itemInfo}>\n              <Text style={[styles.itemTitle, { color: colors.textPrimary }]}>\n                {item.user_name || 'Unknown User'}\n              </Text>\n              <Text style={[styles.itemSubtitle, { color: colors.textSecondary }]}>\n                {item.user_email}\n              </Text>\n            </View>\n          </View>\n          <Text style={[styles.scoreText, { color: risk.color }]}>\n            {item.verification_score}/100\n          </Text>\n        </View>\n\n        <View style={styles.itemDetails}>\n          <Text style={[styles.detailText, { color: colors.textSecondary }]}>\n            NID: ****{item.nid_number.slice(-4)}\n          </Text>\n          <Text style={[styles.detailText, { color: colors.textSecondary }]}>\n            Status: {item.status.replace('_', ' ').toUpperCase()}\n          </Text>\n          <Text style={[styles.detailText, { color: risk.color }]}>\n            Risk: {risk.level}\n          </Text>\n          <Text style={[styles.detailText, { color: colors.textSecondary }]}>\n            Date: {new Date(item.created_at).toLocaleDateString()}\n          </Text>\n          {item.ocr_confidence && (\n            <Text style={[styles.detailText, { color: colors.textSecondary }]}>\n              OCR: {Math.round(item.ocr_confidence * 100)}%\n            </Text>\n          )}\n        </View>\n\n        {item.status === 'pending_review' && (\n          <View style={styles.actionButtons}>\n            <TouchableOpacity\n              style={[styles.actionButton, { backgroundColor: '#10B981' }]}\n              onPress={() => updateVerificationStatus(item.id, 'verified')}\n            >\n              <Ionicons name=\"checkmark\" size={16} color=\"#FFFFFF\" />\n              <Text style={styles.actionButtonText}>Approve</Text>\n            </TouchableOpacity>\n            \n            <TouchableOpacity\n              style={[styles.actionButton, { backgroundColor: '#EF4444' }]}\n              onPress={() => updateVerificationStatus(item.id, 'rejected')}\n            >\n              <Ionicons name=\"close\" size={16} color=\"#FFFFFF\" />\n              <Text style={styles.actionButtonText}>Reject</Text>\n            </TouchableOpacity>\n          </View>\n        )}\n      </View>\n    );\n  };\n\n  return (\n    <View style={[styles.container, { backgroundColor: colors.background }]}>\n      {/* Header */}\n      <View style={[styles.header, { backgroundColor: colors.surface, borderBottomColor: colors.border }]}>\n        <Text style={[styles.headerTitle, { color: colors.textPrimary }]}>\n          ðŸ”’ NID Verification Dashboard\n        </Text>\n        <TouchableOpacity onPress={handleRefresh} style={styles.refreshButton}>\n          <Ionicons name=\"refresh\" size={24} color={colors.primary} />\n        </TouchableOpacity>\n      </View>\n\n      <ScrollView\n        style={styles.content}\n        refreshControl={\n          <RefreshControl refreshing={refreshing} onRefresh={handleRefresh} />\n        }\n      >\n        {/* Statistics */}\n        <View style={styles.statsContainer}>\n          <StatCard \n            title=\"Total\" \n            value={stats.totalVerifications} \n            subtitle=\"Verifications\"\n            color={colors.primary}\n          />\n          <StatCard \n            title=\"Pending\" \n            value={stats.pendingReview} \n            subtitle=\"Review\"\n            color=\"#F59E0B\"\n          />\n          <StatCard \n            title=\"Verified\" \n            value={stats.verified} \n            subtitle=\"Approved\"\n            color=\"#10B981\"\n          />\n          <StatCard \n            title=\"Avg Score\" \n            value={Math.round(stats.averageScore)} \n            subtitle=\"/ 100\"\n            color={colors.primary}\n          />\n        </View>\n\n        {/* Filters */}\n        <View style={styles.filterContainer}>\n          <ScrollView horizontal showsHorizontalScrollIndicator={false}>\n            <FilterButton status=\"all\" label=\"All\" count={stats.totalVerifications} />\n            <FilterButton status=\"pending_review\" label=\"Pending\" count={stats.pendingReview} />\n            <FilterButton status=\"verified\" label=\"Verified\" count={stats.verified} />\n            <FilterButton status=\"rejected\" label=\"Rejected\" count={stats.rejected} />\n            <FilterButton status=\"flagged_for_review\" label=\"Flagged\" count={stats.flagged} />\n          </ScrollView>\n        </View>\n\n        {/* Verification List */}\n        <View style={styles.listContainer}>\n          {verifications.map((item) => (\n            <VerificationItem key={item.id} item={item} />\n          ))}\n          \n          {verifications.length === 0 && !loading && (\n            <View style={styles.emptyState}>\n              <Ionicons name=\"document-text\" size={64} color={colors.textSecondary} />\n              <Text style={[styles.emptyStateText, { color: colors.textSecondary }]}>\n                No verifications found\n              </Text>\n            </View>\n          )}\n        </View>\n      </ScrollView>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n  },\n  header: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'space-between',\n    paddingHorizontal: 16,\n    paddingTop: 60,\n    paddingBottom: 16,\n    borderBottomWidth: 1,\n  },\n  headerTitle: {\n    fontSize: 20,\n    fontWeight: '700',\n  },\n  refreshButton: {\n    padding: 8,\n  },\n  content: {\n    flex: 1,\n  },\n  statsContainer: {\n    flexDirection: 'row',\n    padding: 16,\n    gap: 12,\n  },\n  statCard: {\n    flex: 1,\n    padding: 16,\n    borderRadius: 12,\n    alignItems: 'center',\n  },\n  statValue: {\n    fontSize: 24,\n    fontWeight: '700',\n  },\n  statTitle: {\n    fontSize: 14,\n    fontWeight: '600',\n    marginTop: 4,\n  },\n  statSubtitle: {\n    fontSize: 12,\n    marginTop: 2,\n  },\n  filterContainer: {\n    paddingHorizontal: 16,\n    paddingBottom: 16,\n  },\n  filterButton: {\n    paddingHorizontal: 16,\n    paddingVertical: 8,\n    borderRadius: 20,\n    borderWidth: 1,\n    marginRight: 8,\n  },\n  filterButtonText: {\n    fontSize: 14,\n    fontWeight: '600',\n  },\n  listContainer: {\n    paddingHorizontal: 16,\n  },\n  verificationItem: {\n    padding: 16,\n    marginBottom: 12,\n    borderRadius: 12,\n    borderWidth: 1,\n  },\n  itemHeader: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'space-between',\n    marginBottom: 12,\n  },\n  itemHeaderLeft: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    flex: 1,\n  },\n  itemInfo: {\n    marginLeft: 12,\n    flex: 1,\n  },\n  itemTitle: {\n    fontSize: 16,\n    fontWeight: '600',\n  },\n  itemSubtitle: {\n    fontSize: 14,\n    marginTop: 2,\n  },\n  scoreText: {\n    fontSize: 18,\n    fontWeight: '700',\n  },\n  itemDetails: {\n    gap: 4,\n    marginBottom: 12,\n  },\n  detailText: {\n    fontSize: 12,\n  },\n  actionButtons: {\n    flexDirection: 'row',\n    gap: 8,\n  },\n  actionButton: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    paddingHorizontal: 12,\n    paddingVertical: 6,\n    borderRadius: 6,\n    gap: 4,\n  },\n  actionButtonText: {\n    color: '#FFFFFF',\n    fontSize: 12,\n    fontWeight: '600',\n  },\n  emptyState: {\n    alignItems: 'center',\n    paddingVertical: 64,\n  },\n  emptyStateText: {\n    fontSize: 16,\n    marginTop: 16,\n  },\n});